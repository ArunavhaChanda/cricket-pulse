<!-- templates/match.html -->
{% extends "base.html" %}

{% block title %}{{ match.team1.short_name }} vs {{ match.team2.short_name }} - Cricket Pulse{% endblock %}
{% block subtitle %}Live Cricket Match Simulation{% endblock %}

{% block extra_css %}
<style>
    /* Add your custom CSS here */
    
    /* Event Animation System */
    .event-animation {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 9999;
        pointer-events: none;
        opacity: 0;
        transition: all 0.5s ease;
    }
    
    .event-animation.animate {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
    }
    
    .event-animation.fade-out {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.8);
    }
    
    .animation-content {
        text-align: center;
        padding: 30px 50px;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        backdrop-filter: blur(10px);
        border: 3px solid;
        animation: pulseGlow 2s ease-in-out;
    }
    
    .animation-title {
        font-size: 4rem;
        font-weight: bold;
        margin-bottom: 10px;
        text-shadow: 0 0 20px currentColor;
        animation: textShake 0.5s ease-in-out 0.5s;
    }
    
    .animation-subtitle {
        font-size: 1.5rem;
        opacity: 0.9;
        animation: fadeInUp 0.8s ease-out 0.3s both;
    }
    
    /* Six Animation - Golden and Glowing */
    .six-animation .animation-content {
        background: linear-gradient(135deg, rgba(255,215,0,0.9), rgba(255,165,0,0.9));
        border-color: #ffd700;
        color: #8b4513;
    }
    
    .six-animation .animation-title {
        animation: sixBounce 1s ease-out 0.5s;
    }
    
    /* Four Animation - Blue and Electric */
    .four-animation .animation-content {
        background: linear-gradient(135deg, rgba(30,144,255,0.9), rgba(0,191,255,0.9));
        border-color: #1e90ff;
        color: #fff;
    }
    
    .four-animation .animation-title {
        animation: fourSlide 1s ease-out 0.5s;
    }
    
    /* Wicket Animation - Red and Fiery */
    .wicket-animation .animation-content {
        background: linear-gradient(135deg, rgba(220,20,60,0.9), rgba(255,69,0,0.9));
        border-color: #dc143c;
        color: #fff;
    }
    
    .wicket-animation .animation-title {
        animation: wicketExplode 1s ease-out 0.5s;
    }
    
    /* Keyframe Animations */
    @keyframes pulseGlow {
        0%, 100% { box-shadow: 0 20px 40px rgba(0,0,0,0.5); }
        50% { box-shadow: 0 20px 40px rgba(255,255,255,0.3), 0 0 60px currentColor; }
    }
    
    @keyframes textShake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }
    
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes sixBounce {
        0% { transform: scale(1); }
        50% { transform: scale(1.2) rotate(5deg); }
        100% { transform: scale(1) rotate(0deg); }
    }
    
    @keyframes fourSlide {
        0% { transform: translateX(-50px); opacity: 0; }
        100% { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes wicketExplode {
        0% { transform: scale(1) rotate(0deg); }
        50% { transform: scale(1.3) rotate(180deg); }
        100% { transform: scale(1) rotate(360deg); }
    }
    
    /* Sound Controls Styling */
    .sound-controls {
        margin-top: 20px;
        padding: 15px;
        background: rgba(0,0,0,0.3);
        border-radius: 10px;
        border: 1px solid rgba(33,150,243,0.2);
        text-align: center;
    }
    
    .volume-control {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        margin-top: 10px;
    }
    
    .volume-control label {
        font-size: 1.2rem;
        color: #e3f2fd;
    }
    
    .volume-control input[type="range"] {
        width: 120px;
        height: 6px;
        background: rgba(33,150,243,0.3);
        border-radius: 3px;
        outline: none;
        -webkit-appearance: none;
    }
    
    .volume-control input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 18px;
        height: 18px;
        background: #2196f3;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    
    .volume-control input[type="range"]::-moz-range-thumb {
        width: 18px;
        height: 18px;
        background: #2196f3;
        border-radius: 50%;
        cursor: pointer;
        border: none;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
let matchState = {
    currentInnings: 1, // 1 for first innings, 2 for second innings
    battingTeam: null,
    battingOrderPlayers: null,
    bowlingTeam: null,
    striker: null,
    nonStriker: null,
    currentBowler: null,
    fielder: null,
    wicketkeeper: null,
    isAutoSimulating: false,
    autoInterval: null,
    firstInningsScore: 0, // Store first innings total
    target: 0, // Target for second innings
    secondInningsBattingTeam: null, // Team batting in second innings
    secondInningsBowlingTeam: null, // Team bowling in second innings
    matchResult: null // Store final match result
};

// Initialize match interface
document.addEventListener('DOMContentLoaded', function() {
    // Initialize sound system
    soundSystem.init();
    
    // Set initial display based on match status
    initializeMatchDisplay();
    
    // Join match room for real-time updates
    socket.emit('join_match', { match_id: MATCH_DATA.match_id });
    
    // Load current match state
    loadMatchState();
    
    // Set up WebSocket event listeners
    setupWebSocketListeners();
});

function initializeMatchDisplay() {
    // Show appropriate sections based on match status
    if (MATCH_DATA.status === 'setup') {
        document.getElementById('toss-section').style.display = 'block';
    }
}

function setupWebSocketListeners() {
    socket.on('toss_result', function(data) {
        if (data.match_id === MATCH_DATA.match_id) {
            handleTossResult(data);
        }
    });
    
    socket.on('toss_decision', function(data) {
        if (data.match_id === MATCH_DATA.match_id) {
            handleTossDecision(data);
        }
    });
    
    socket.on('match_started', function(data) {
        if (data.match_id === MATCH_DATA.match_id) {
            handleMatchStart(data);
        }
    });
    
    socket.on('delivery_update', function(data) {
        if (data.match_id === MATCH_DATA.match_id) {
            console.log('WebSocket delivery_update received:', data);
            
            // Process the server data properly
            if (data.delivery_result) {
                const processedData = {
                    type: processDeliveryType(data.delivery_result.runs_scored, data.delivery_result.is_wicket, data.delivery_result.extras) || 'unknown',
                    runs: data.delivery_result.runs_scored || 0,
                    extras: data.delivery_result.extras || 0,
                    isWicket: data.delivery_result.is_wicket || false,
                    dismissal_type: data.delivery_result.dismissal_type || null,
                    ballNumber: (matchState.currentBalls || 0) + 1,
                    overNumber: Math.floor((matchState.currentBalls || 0) / 6) + 1
                };
                
                console.log('Processed WebSocket data:', processedData);
                handleDeliveryUpdate({
                    match_id: data.match_id,
                    ...processedData
                });
            } else {
                console.error('No delivery_result in WebSocket data:', data);
            }
        }
    });

    socket.on('innings_complete', function(data) {
        if (data.match_id === MATCH_DATA.match_id) {
            handleInningsComplete(data);
        }
    });
    
    socket.on('match_complete', function(data) {
        if (data.match_id === MATCH_DATA.match_id) {
            handleMatchComplete(data);
        }
    });
}

function loadMatchState() {
    // This would fetch the current match state from the server
    // For now, we'll use the initial state from the template
    updateMatchDisplay();
}

function conductToss() {
    const selectedRadio = document.querySelector('input[name="toss-call"]:checked');
    let call; // Declare call variable outside the if/else blocks
    
    if (selectedRadio) {
        call = selectedRadio.value;
    } else {
        console.error('No toss call selected; heads given as default');
        call = "heads";
    }
    
    fetch(`/api/matches/${MATCH_DATA.match_id}/toss`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            calling_team_id: MATCH_DATA.team1.id,
            call: call
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showNotification(data.error, 'error');
        } else {
            // Toss result will be handled by WebSocket
            showNotification('Toss conducted!', 'success');
        }
    })
    .catch(error => {
        showNotification('Error conducting toss', 'error');
        console.error('Error:', error);
    });
}

function handleTossResult(data) {
    // Hide toss section
    document.getElementById('toss-section').style.display = 'none';
    
    // Show toss decision section
    const tossDecisionSection = document.getElementById('toss-decision-section');
    const resultText = document.getElementById('toss-result-text');
    
    resultText.innerHTML = `
        <div style="margin-bottom: 15px;">
            <strong>🪙 Toss Result: ${data.toss_result.toUpperCase()}</strong><br>
            ${data.calling_team} called ${data.call}<br>
            🏆 <span style="color: #ffd700;">${data.toss_winner} wins the toss!</span>
        </div>
        <p>Choose what to do:</p>
    `;
    
    tossDecisionSection.style.display = 'block';
    
    // Update ticker
    updateTicker(`🪙 ${data.toss_winner} wins the toss • 🎯 Deciding whether to bat or bowl first`);
}

function makeTossDecision(decision) {
    fetch(`/api/matches/${MATCH_DATA.match_id}/toss-decision`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            decision: decision
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showNotification(data.error, 'error');
        } else {
            showNotification('Decision made!', 'success');
        }
    })
    .catch(error => {
        showNotification('Error making decision', 'error');
        console.error('Error:', error);
    });
}

function handleTossDecision(data) {
    // Hide toss decision section
    document.getElementById('toss-decision-section').style.display = 'none';
    
    // Show start section
    const startSection = document.getElementById('start-section');
    const battingOrderText = document.getElementById('batting-order-text');
    
    battingOrderText.innerHTML = `
        <div style="margin-bottom: 15px;">
            <strong>🏏 ${data.batting_first} will bat first</strong><br>
            <strong>⚾ ${data.bowling_first} will bowl first</strong>
        </div>
        <p>Ready to start the match?</p>
    `;
    
    startSection.style.display = 'block';
    
    // Update match state
    matchState.battingTeam = data.batting_first === MATCH_DATA.team1.short_name ? MATCH_DATA.team1 : MATCH_DATA.team2;
    matchState.battingOrderPlayers = [];
    matchState.bowlingTeam = data.batting_first === MATCH_DATA.team1.short_name ? MATCH_DATA.team2 : MATCH_DATA.team1;
    
    // Update ticker
    updateTicker(`🏏 ${data.batting_first} to bat first • ⚾ ${data.bowling_first} to bowl • 🚀 Match starting soon`);
}

function startMatch() {
    fetch(`/api/matches/${MATCH_DATA.match_id}/start`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showNotification(data.error, 'error');
        } else {
            showNotification('Match started!', 'success');
        }
    })
    .catch(error => {
        showNotification('Error starting match', 'error');
        console.error('Error:', error);
    });
}

function handleMatchStart(data) {
    // Hide start section
    document.getElementById('start-section').style.display = 'none';
    
    // Show live controls
    document.getElementById('live-controls').style.display = 'block';
    
    // Show match elements
    document.getElementById('player-status').style.display = 'grid';
    document.getElementById('over-display').style.display = 'block';
    
    // Update status
    updateMatchStatus('live');
    
    // Initialize first innings
    matchState.currentInnings = 1;
    matchState.totalRuns = 0;
    matchState.wicketsLost = 0;
    matchState.ballsFaced = 0;
    matchState.currentBalls = 0;
    matchState.battingOrderPlayers = [];
    matchState.wicketkeeper = matchState.bowlingTeam.players.find(p => p.is_wicketkeeper);
    
    // Clear projection info and previous result
    document.getElementById('projection-info').textContent = '';
    matchState.matchResult = null;
    
    // Initialize match display
    updateMatchDisplay();
    
    // Update ticker
    updateTicker(`🏏 Match has begun! • First innings in progress • ${data.batting_team} batting`);
    
    // Prompt for opening batsmen and bowler selection
    selectOpeningPlayers();
}

function selectOpeningPlayers() {
    // Open modal for user to select opening players
    if (matchState.battingTeam && matchState.bowlingTeam) {
        openPlayerSelectionModal();
    } else {
        showNotification('Teams not loaded yet', 'error');
    }
}

function openPlayerSelectionModal() {
    const modal = document.getElementById('player-modal');
    
    // Populate dropdowns with available players
    populatePlayerDropdowns();
    
    // Show modal
    modal.style.display = 'block';
    
    // Add event listeners for player selection changes
    document.getElementById('striker-select').addEventListener('change', updatePlayerPreview);
    document.getElementById('non-striker-select').addEventListener('change', updatePlayerPreview);
    document.getElementById('bowler-select').addEventListener('change', updatePlayerPreview);
}

function populatePlayerDropdowns() {
    const strikerSelect = document.getElementById('striker-select');
    const nonStrikerSelect = document.getElementById('non-striker-select');
    const bowlerSelect = document.getElementById('bowler-select');
    
    // Clear existing options
    strikerSelect.innerHTML = '<option value="">Choose striker...</option>';
    nonStrikerSelect.innerHTML = '<option value="">Choose non-striker...</option>';
    bowlerSelect.innerHTML = '<option value="">Choose bowler...</option>';
    
    // Populate batsmen dropdowns
    matchState.battingTeam.players.forEach(player => {
        const strikerOption = document.createElement('option');
        strikerOption.value = player.id;
        strikerOption.textContent = `${player.name} (vs Pace: ${player.batting_vs_pace}, vs Spin: ${player.batting_vs_spin}, Aggression: ${player.batting_aggression})`;
        strikerSelect.appendChild(strikerOption);
        
        const nonStrikerOption = document.createElement('option');
        nonStrikerOption.value = player.id;
        nonStrikerOption.textContent = `${player.name} (vs Pace: ${player.batting_vs_pace}, vs Spin: ${player.batting_vs_spin}, Aggression: ${player.batting_aggression})`;
        nonStrikerSelect.appendChild(nonStrikerOption);
    });
    
    // Populate bowler dropdown
    matchState.bowlingTeam.players.forEach(player => {
        const bowlerOption = document.createElement('option');
        bowlerOption.value = player.id;
        bowlerOption.textContent = `${player.name} (Bowl: ${player.bowling_type}, ${player.bowling_skill})`;
        bowlerSelect.appendChild(bowlerOption);
    });
}

function updatePlayerPreview() {
    const strikerId = document.getElementById('striker-select').value;
    const nonStrikerId = document.getElementById('non-striker-select').value;
    const bowlerId = document.getElementById('bowler-select').value;
    
    const previewDiv = document.getElementById('player-preview');
    let previewHTML = '<h4>📊 Player Preview</h4>';
    
    if (strikerId) {
        const striker = matchState.battingTeam.players.find(p => p.id == strikerId);
        previewHTML += `
            <div class="player-preview-item">
                <strong>🏏 Striker:</strong> ${striker.name}<br>
                Skill vs Pace: ${striker.batting_vs_pace} | Skill vs Spin: ${striker.batting_vs_spin} | Aggression: ${striker.batting_aggression}
            </div>
        `;
    }
    
    if (nonStrikerId) {
        const nonStriker = matchState.battingTeam.players.find(p => p.id == nonStrikerId);
        previewHTML += `
            <div class="player-preview-item">
                <strong>🏏 Non-striker:</strong> ${nonStriker.name}<br>
                Skill vs Pace: ${nonStriker.batting_vs_pace} | Skill vs Spin: ${nonStriker.batting_vs_spin} | Aggression: ${nonStriker.batting_aggression}
            </div>
        `;
    }
    
    if (bowlerId) {
        const bowler = matchState.bowlingTeam.players.find(p => p.id == bowlerId);
        previewHTML += `
            <div class="player-preview-item">
                <strong>⚾ Bowler:</strong> ${bowler.name}<br>
                Bowling: ${bowler.bowling_skill} | ${bowler.bowling_type}
            </div>
        `;
    }
    
    previewDiv.innerHTML = previewHTML;
}

function confirmPlayerSelection() {
    const strikerId = document.getElementById('striker-select').value;
    const nonStrikerId = document.getElementById('non-striker-select').value;
    const bowlerId = document.getElementById('bowler-select').value;
    
    // Validate selection
    if (!strikerId || !nonStrikerId || !bowlerId) {
        showNotification('Please select all three players', 'error');
        return;
    }
    
    if (strikerId === nonStrikerId) {
        showNotification('Striker and non-striker must be different players', 'error');
        return;
    }
    
    // Set the selected players
    matchState.striker = matchState.battingTeam.players.find(p => p.id == strikerId);
    matchState.battingOrderPlayers.push(matchState.striker);
    matchState.nonStriker = matchState.battingTeam.players.find(p => p.id == nonStrikerId);
    matchState.battingOrderPlayers.push(matchState.nonStriker);
    matchState.currentBowler = matchState.bowlingTeam.players.find(p => p.id == bowlerId);
    
    // Close modal
    closePlayerModal();
    
    // Update display
    updatePlayerDisplay();
    
    // Show confirmation
    showNotification(`Opening players selected: ${matchState.striker.name}, ${matchState.nonStriker.name}, ${matchState.currentBowler.name}`, 'success');
}

function closePlayerModal() {
    const modal = document.getElementById('player-modal');
    modal.style.display = 'none';
    
    // Remove event listeners
    document.getElementById('striker-select').removeEventListener('change', updatePlayerPreview);
    document.getElementById('non-striker-select').removeEventListener('change', updatePlayerPreview);
    document.getElementById('bowler-select').removeEventListener('change', updatePlayerPreview);
}

function simulateDelivery() {
    if (!matchState.striker || !matchState.nonStriker || !matchState.currentBowler) {
        showNotification('Please select players first', 'error');
        return;
    }
    
    // This is where you'd integrate with your Python cricket simulation logic
    // For now, we'll create a mock delivery
    const mockDelivery = generateMockDelivery();
    matchState.fielder = matchState.battingTeam.players[Math.floor(Math.random() * 11)];
    
    // Send delivery to server for processing
    fetch(`/api/matches/${MATCH_DATA.match_id}/simulate-delivery`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            bowler_id: matchState.currentBowler.id,
            striker_id: matchState.striker.id,
            non_striker_id: matchState.nonStriker.id,
            fielder_id: matchState.fielder.id,
            wicketkeeper_id: matchState.wicketkeeper.id
        })
    })
    .then(response => response.json())
        .then(data => {
        if (data.error) {
            showNotification(data.error, 'error');
        } else {
            // Delivery result will be handled by WebSocket
            console.log('Server response received:', data);
            console.log('Waiting for WebSocket delivery_update event...');
            
            // // Check if we have server data or need to use mock
            // if (data && data.delivery_result) {
            //     console.log('Using server data');
            //     console.log('Current balls:', matchState.currentBalls);
            //     deliveryData = processDeliveryData(data);
            // } else {
            //     console.log('Using mock data');
            //     deliveryData = mockDelivery;
            // }
            
            // handleDeliveryUpdate({
            //     match_id: MATCH_DATA.match_id,
            //     ...deliveryData
            // });

            // Don't call handleDeliveryUpdate here - let WebSocket handle it
            // This prevents duplicate processing
        }
    })
    .catch(error => {
        // For demo purposes, if the API isn't implemented yet, use mock data
        console.log('Using mock delivery data');
        handleDeliveryUpdate({
            match_id: MATCH_DATA.match_id,
            ...mockDelivery
        });
    });
}

function processDeliveryType(runsScored, isWicket, extras) {
    let delivery_type = "dot";
    // Try to access the data with fallbacks
    if (isWicket) {
        delivery_type = "wicket";
    } else if (extras > 0) {
        delivery_type = "wide"; // Handle no ball
    } else if (runsScored > 0) {
        if (runsScored == 4) {
            delivery_type = "four";
        } else if (runsScored == 6) {
            delivery_type = "six";
        } else {
            delivery_type = "runs";
        }
    }
    return delivery_type;
}

function processDeliveryData(data) {
    // Debug: Log the entire data structure
    console.log('Raw data received:', data);
    console.log('Data keys:', Object.keys(data));
    
    // Check if data.delivery_result exists
    if (data.delivery_result) {
        console.log('delivery_result keys:', Object.keys(data.delivery_result));
    }
    
    let delivery_type = "dot";
    // Try to access the data with fallbacks
    if (data.delivery_result && data.delivery_result.is_wicket) {
        delivery_type = "wicket";
    } else if (data.delivery_result && data.delivery_result.extras > 0) {
        delivery_type = "wide"; // Handle no ball
    } else if (data.delivery_result && data.delivery_result.runs_scored > 0) {
        if (data.delivery_result.runs_scored == 4) {
            delivery_type = "four";
        } else if (data.delivery_result.runs_scored == 6) {
            delivery_type = "six";
        } else {
            delivery_type = "runs";
        }
    }

    console.log('Delivery type:', delivery_type);

    const outcome = {
        type: delivery_type,
        runs: data.delivery_result?.runs_scored || data.runs || 0,
        extras: data.delivery_result?.extras || data.extras || 0,
        isWicket: data.delivery_result?.is_wicket || data.isWicket || false
    };
    
    console.log('Processed outcome:', outcome);
    
    return {
        ...outcome,
        ballNumber: (matchState.currentBalls || 0) + 1,
        overNumber: Math.floor((matchState.currentBalls || 0) / 6) + 1
    };
}

function generateMockDelivery() {
    // Mock delivery generation for demo purposes
    const outcomes = [
        { type: 'dot', runs: 0, extras: 0, isWicket: false },
        { type: 'runs', runs: 1, extras: 0, isWicket: false },
        { type: 'runs', runs: 2, extras: 0, isWicket: false },
        { type: 'runs', runs: 3, extras: 0, isWicket: false },
        { type: 'four', runs: 4, extras: 0, isWicket: false },
        { type: 'six', runs: 6, extras: 0, isWicket: false },
        { type: 'wicket', runs: 0, extras: 0, isWicket: true },
        { type: 'wide', runs: 1, extras: 1, isWicket: false },
        { type: 'noball', runs: 1, extras: 1, isWicket: false }
    ];
    
    const weights = [30, 25, 15, 8, 12, 5, 3, 1, 1]; // Probability weights
    const randomIndex = weightedRandom(weights);
    
    const mockDelivery = {
        ...outcomes[randomIndex],
        ballNumber: (matchState.currentBalls || 0) + 1,
        overNumber: Math.floor((matchState.currentBalls || 0) / 6) + 1
    };
    
    console.log('Current balls:', matchState.currentBalls);
    console.log('Generated mock delivery:', mockDelivery);
    return mockDelivery;
}

function weightedRandom(weights) {
    const totalWeight = weights.reduce((sum, weight) => sum + weight, 0);
    let random = Math.random() * totalWeight;
    
    for (let i = 0; i < weights.length; i++) {
        random -= weights[i];
        if (random <= 0) {
            return i;
        }
    }
    return weights.length - 1;
}

function handleDeliveryUpdate(data) {
    // Add ball to display
    addBallToOver(data);
    
    // Update scores and stats
    updateScoreAfterDelivery(data);
    
    // Update player stats
    updatePlayerStats(data);
    
    // Update ticker with commentary
    updateTickerWithDelivery(data);
    
    // Check for wicket or over completion
    if (data.isWicket) {
        // Show wicket result first, then prompt for next action
        showDeliveryResult(data, 'wicket');
    } else if ((data.ballNumber % 6 === 0) && data.extras === 0) {
        // Show over completion result first, then prompt for next action
        showDeliveryResult(data, 'over');
    } else {
        // Regular delivery - continue normally
        // Check for innings completion
        checkInningsCompletion();
    }
}

function showDeliveryResult(data, resultType) {
    // Disable the "Next Ball" button temporarily
    const nextBallBtn = document.getElementById('next-ball-btn');
    nextBallBtn.disabled = true;
    
    // Show result message
    // let resultMessage = '';
    // if (resultType === 'wicket') {
    //     resultMessage = `🔥 WICKET! ${matchState.striker.name} is out!`;
    // } else if (resultType === 'over') {
    //     resultMessage = `🏏 Over completed!`;
    // }
    
    // // Update ticker with result
    // updateTicker(resultMessage);
    
    // Wait 2 seconds to show the result, then enable action button
    setTimeout(() => {
        if (resultType === 'wicket') {
            // Change button to "Select Next Batsman"
            nextBallBtn.textContent = '🏏 Select Next Batsman';
            nextBallBtn.onclick = () => {
                handleWicket(data);
            };
        } else if (resultType === 'over') {
            // Change button to "Select Next Bowler"
            nextBallBtn.textContent = '⚾ Select Next Bowler';
            nextBallBtn.onclick = () => {
                completeOver();
            };
        }
        
        // Re-enable button
        nextBallBtn.disabled = false;
    }, 500);
}

function addBallToOver(data) {
    const ballsContainer = document.getElementById('balls-container');
    const ball = document.createElement('div');
    ball.className = `ball ${data.type}`;
    
    if (data.isWicket) {
        ball.textContent = 'W';
        ball.className = 'ball wicket';
    } else if (data.type === 'wide' || data.type === 'noball') {
        ball.textContent = data.type === 'wide' ? 'Wd' : 'Nb';
    } else {
        ball.textContent = data.runs === 0 ? '•' : data.runs;
    }
    
    ballsContainer.appendChild(ball);
    
    // Update over number display
    const currentBalls = ballsContainer.children.length;
    const overNum = Math.floor((currentBalls - 1) / 6) + 1;
    const ballInOver = ((currentBalls - 1) % 6) + 1;
    
    document.getElementById('over-number').textContent = `Over ${overNum}.${ballInOver}`;
}

function updateScoreAfterDelivery(data) {
    // Update team score (this would come from server in real implementation)
    matchState.totalRuns = (matchState.totalRuns || 0) + data.runs + data.extras;
    // matchState.wicketsLost = (matchState.wicketsLost || 0) + (data.isWicket ? 1 : 0);  // No need to double-count wicket fall
    matchState.ballsFaced = (matchState.ballsFaced || 0) + (data.extras > 0 ? 0 : 1);
    matchState.currentBalls = (matchState.currentBalls || 0) + (data.extras > 0 ? 0 : 1);
    
    // Update display
    const team1Score = document.getElementById('team1-score');
    const team1RR = document.getElementById('team1-rr');
    
    team1Score.textContent = `${matchState.totalRuns}/${matchState.wicketsLost}`;

    
    const overs = Math.floor(matchState.ballsFaced / 6) + (matchState.ballsFaced % 6) / 10;
    const runRate = (matchState.ballsFaced > 0) ? (matchState.totalRuns * 6 / matchState.ballsFaced).toFixed(2) : '0.00';

    console.log('Current balls:', matchState.currentBalls);
    console.log('Balls faced:', matchState.ballsFaced);
    console.log('Overs:', overs);

    if (matchState.currentInnings === 1) {
        // First innings - show run rate only        
        team1RR.textContent = `RR: ${runRate}`;
        
        // Show projected score for first innings
        const projectedScore = Math.round(runRate * MATCH_DATA.max_overs);
        document.getElementById('projection-info').textContent = `Projected score: ${projectedScore}`;
    } else {
        // Second innings - show run rate and required run rate
        const remainingRuns = matchState.target - matchState.totalRuns;
        const remainingBalls = (MATCH_DATA.max_overs * 6) - matchState.ballsFaced;
        const requiredRunRate = remainingBalls > 0 ? (remainingRuns * 6 / remainingBalls).toFixed(2) : '0.00';
        
        team1RR.textContent = `RR: ${runRate} | RRR: ${requiredRunRate}`;
        
        // Show runs needed for second innings
        document.getElementById('projection-info').textContent = `Need ${remainingRuns} runs from ${remainingBalls} balls`;
    }
    
    // Update overs display
    document.getElementById('match-overs').textContent = `${overs.toFixed(1)}/${MATCH_DATA.max_overs} overs`;
    
    // Check if target is reached in second innings
    if (matchState.currentInnings === 2 && matchState.totalRuns >= matchState.target) {
        updateTicker(`🎯 TARGET ACHIEVED! ${matchState.battingTeam.short_name} wins the match!`);
        setTimeout(() => {
            endInnings();
        }, 2000);
    }
}

function updatePlayerStats(data) {
    // Update striker stats
    if (matchState.striker) {
        matchState.striker.runs = (matchState.striker.runs || 0) + data.runs;
        matchState.striker.ballsFaced = (matchState.striker.ballsFaced || 0) + (data.extras > 0 ? 0 : 1);
        matchState.striker.fours = (matchState.striker.fours || 0) + (data.runs === 4 ? 1 : 0);
        matchState.striker.sixes = (matchState.striker.sixes || 0) + (data.runs === 6 ? 1 : 0);
        
        const sr = matchState.striker.ballsFaced > 0 ? 
            ((matchState.striker.runs / matchState.striker.ballsFaced) * 100).toFixed(1) : '0.0';
        
        document.getElementById('striker-name').textContent = matchState.striker.name;
        document.getElementById('striker-stats').innerHTML = 
            `${matchState.striker.runs}* (${matchState.striker.ballsFaced}) | SR: ${sr}<br>4s: ${matchState.striker.fours || 0} • 6s: ${matchState.striker.sixes || 0}`;
    }

    // Update bowler stats
    if (matchState.currentBowler) {
        matchState.currentBowler.oversBowled = (matchState.currentBowler.oversBowled || 0) + (data.extras > 0 ? 0 : 0.1);
        matchState.currentBowler.runsConceded = (matchState.currentBowler.runsConceded || 0) + data.runs + data.extras;
        matchState.currentBowler.wicketsTaken = (matchState.currentBowler.wicketsTaken || 0) + (data.isWicket ? 1 : 0);
        
        document.getElementById('bowler-name').textContent = matchState.currentBowler.name;
    }
    
    // Swap strike on odd runs
    if (data.runs % 2 === 1 && !data.isWicket) {
        swapStrike();
    }
    updateMatchDisplay();
}

function swapStrike() {
    const temp = matchState.striker;
    matchState.striker = matchState.nonStriker;
    matchState.nonStriker = temp;
    
    updatePlayerDisplay();
}

function updatePlayerDisplay() {
    const strikerDiv = document.getElementById('striker');
    const nonStrikerDiv = document.getElementById('non-striker');
    
    // Remove on-strike class from both
    strikerDiv.classList.remove('on-strike');
    nonStrikerDiv.classList.remove('on-strike');
    
    // Add on-strike class to current striker
    strikerDiv.classList.add('on-strike');
    
    // Update names and stats
    if (matchState.striker) {
        document.getElementById('striker-name').textContent = matchState.striker.name;
        const strikerSR = matchState.striker.ballsFaced > 0 ? 
            ((matchState.striker.runs || 0) / matchState.striker.ballsFaced * 100).toFixed(1) : '0.0';
        document.getElementById('striker-stats').innerHTML = 
            `${matchState.striker.runs || 0}* (${matchState.striker.ballsFaced || 0}) | SR: ${strikerSR}<br>4s: ${matchState.striker.fours || 0} • 6s: ${matchState.striker.sixes || 0}`;
    }
    
    if (matchState.nonStriker) {
        document.getElementById('non-striker-name').textContent = matchState.nonStriker.name;
        const nonStrikerSR = matchState.nonStriker.ballsFaced > 0 ? 
            ((matchState.nonStriker.runs || 0) / matchState.nonStriker.ballsFaced * 100).toFixed(1) : '0.0';
        document.getElementById('non-striker-stats').innerHTML = 
            `${matchState.nonStriker.runs || 0}* (${matchState.nonStriker.ballsFaced || 0}) | SR: ${nonStrikerSR}<br>4s: ${matchState.nonStriker.fours || 0} • 6s: ${matchState.nonStriker.sixes || 0}`;
    }
}

function updateTickerWithDelivery(data) {
    let commentary = '';
    
    if (data.isWicket) {
        // Enhanced wicket commentary with dismissal type
        let dismissalText = '';
        if (data.dismissal_type) {
            switch(data.dismissal_type) {
                case 'bowled':
                    dismissalText = 'BOWLED!';
                    break;
                case 'lbw':
                    dismissalText = 'LBW!';
                    break;
                case 'caught':
                    dismissalText = 'CAUGHT!';
                    break;
                case 'stumped':
                    dismissalText = 'STUMPED!';
                    break;
                case 'caught behind':
                    dismissalText = 'CAUGHT BEHIND!';
                    break;
                default:
                    dismissalText = 'OUT!';
            }
        } else {
            dismissalText = 'OUT!';
        }
        
        commentary = `🔥 WICKET! ${matchState.striker.name} ${dismissalText} • ${matchState.currentBowler.name} strikes`;
        
        // Show exciting wicket animation
        showEventAnimation('WICKET!', 'wicket', dismissalText);
        
    } else if (data.runs === 6) {
        commentary = `🚀 SIX! ${matchState.striker.name} sends it into the stands • Magnificent shot`;
        
        // Show exciting six animation
        showEventAnimation('SIX!', 'six', '🚀');
        
    } else if (data.runs === 4) {
        commentary = `🎯 FOUR! ${matchState.striker.name} finds the boundary • Excellent timing`;
        
        // Show exciting four animation
        showEventAnimation('FOUR!', 'four', '🎯');
    } else if (data.type === 'wide') {
        commentary = `↔️ Wide ball • Extra run to the batting side`;
    } else if (data.type === 'noball') {
        commentary = `❌ No ball • Free hit coming up`;
    } else if (data.runs === 0) {
        commentary = `⚫ Dot ball • Good bowling by ${matchState.currentBowler.name}`;
    } else {
        commentary = `▶️ ${data.runs} run${data.runs > 1 ? 's' : ''} • ${matchState.striker.name} keeps the scoreboard ticking`;
    }
    
    updateTicker(commentary);
}

function handleWicket(data) {
    // Mark current striker as out
    if (matchState.striker) {
        matchState.striker.isOut = true;
    }
    
    // Increment wickets
    matchState.wicketsLost = (matchState.wicketsLost || 0) + 1; // No need to double-count wicket fall
    
    // Check if innings should end
    if (matchState.wicketsLost >= 10) {
        endInnings();
        return;
    }
    
    // Check if this wicket occurred on the last ball of an over
    const currentBalls = matchState.currentBalls || 0;
    const isLastBallOfOver = (currentBalls % 6 === 0);
    
    console.log(`Wicket on ball ${currentBalls}, isLastBallOfOver: ${isLastBallOfOver}`);
    
    if (isLastBallOfOver) {
        // Wicket on last ball of over - need both new batsman AND new bowler
        console.log('Wicket on last ball of over - will select new batsman then new bowler');
        selectNewBatsman();
        // Note: The bowler selection will be handled in confirmNewBatsman() after batsman selection
    } else {
        // Regular wicket - just select new batsman
        console.log('Regular wicket - just selecting new batsman');
        selectNewBatsman();
    }
    
    // Reset button to "Next Ball" after selection
    resetNextBallButton();
}

function selectNewBatsman() {
    // Get available batsmen (not out, not currently batting, not already in batting order)
    const availableBatsmen = matchState.battingTeam.players.filter(player => 
        !player.isOut && 
        player.id !== matchState.striker.id && 
        player.id !== matchState.nonStriker.id &&
        !matchState.battingOrderPlayers.some(battingPlayer => battingPlayer.id === player.id)
    );
    
    if (availableBatsmen.length > 0) {
        // Open modal for user to select new batsman
        openNewBatsmanModal(availableBatsmen);
    } else {
        // No more batsmen available - innings should end
        showNotification('No more batsmen available - innings ending', 'info');
        endInnings();
    }
}

function openNewBatsmanModal(availableBatsmen) {
    const modal = document.getElementById('player-modal');
    
    // Update modal title and content for new batsman selection
    document.getElementById('modal-title').textContent = '🏏 Select New Batsman';
    
    // Clear previous content
    const modalContent = modal.querySelector('.modal-content');
    
    // Create new batsman selection interface
    modalContent.innerHTML = `
        <h3 id="modal-title">🏏 Select New Batsman</h3>
        
        <div class="selection-section">
            <h4>🔄 New Batsman Selection</h4>
            <p>Choose who comes to the crease next:</p>
            
            <div class="player-grid">
                <div class="player-column">
                    <label>New Batsman:</label>
                    <select id="new-batsman-select" class="player-select-dropdown">
                        <option value="">Choose new batsman...</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Player Stats Preview -->
        <div class="player-preview" id="player-preview">
            <!-- Player stats will be shown here -->
        </div>
        
        <!-- Action Buttons -->
        <div class="modal-actions">
            <button class="btn btn-primary" onclick="confirmNewBatsman()">✅ Confirm Selection</button>
            <button class="btn btn-secondary" onclick="closeNewBatsmanModal()">❌ Cancel</button>
        </div>
    `;
    
    // Populate dropdown with available batsmen
    populateNewBatsmanDropdown(availableBatsmen);
    
    // Show modal
    modal.style.display = 'block';
    
    // Add event listener for batsman selection changes
    document.getElementById('new-batsman-select').addEventListener('change', updateNewBatsmanPreview);
}

function populateNewBatsmanDropdown(availableBatsmen) {
    const batsmanSelect = document.getElementById('new-batsman-select');
    
    // Clear existing options
    batsmanSelect.innerHTML = '<option value="">Choose new batsman...</option>';
    
    // Populate dropdown with available batsmen
    availableBatsmen.forEach(player => {
        const option = document.createElement('option');
        option.value = player.id;
        option.textContent = `${player.name} (vs Pace: ${player.batting_vs_pace}, vs Spin: ${player.batting_vs_spin}, Aggression: ${player.batting_aggression})`;
        batsmanSelect.appendChild(option);
    });
}

function updateNewBatsmanPreview() {
    const batsmanId = document.getElementById('new-batsman-select').value;
    const previewDiv = document.getElementById('player-preview');
    
    if (batsmanId) {
        const batsman = matchState.battingTeam.players.find(p => p.id == batsmanId);
        previewDiv.innerHTML = `
            <h4>📊 New Batsman Preview</h4>
            <div class="player-preview-item">
                <strong>🏏 New Batsman:</strong> ${batsman.name}<br>
                Skill vs Pace: ${batsman.batting_vs_pace} | Skill vs Spin: ${batsman.batting_vs_spin} | Aggression: ${batsman.batting_aggression}
            </div>
        `;
    } else {
        previewDiv.innerHTML = '<h4>📊 New Batsman Preview</h4><p>Select a batsman to see their stats</p>';
    }
}

function confirmNewBatsman() {
    const batsmanId = document.getElementById('new-batsman-select').value;
    
    if (!batsmanId) {
        showNotification('Please select a new batsman', 'error');
        return;
    }
    
    // Get the selected batsman
    const newBatsman = matchState.battingTeam.players.find(p => p.id == batsmanId);
    
    // Set as new striker
    matchState.striker = newBatsman;
    matchState.battingOrderPlayers.push(matchState.striker);
    
    // Initialize batsman stats
    matchState.striker.runs = 0;
    matchState.striker.ballsFaced = 0;
    matchState.striker.fours = 0;
    matchState.striker.sixes = 0;
    
    // Close modal
    closeNewBatsmanModal();
    
    // Update display
    updatePlayerDisplay();
    
    // Show confirmation
    showNotification(`${matchState.striker.name} comes to the crease`, 'success');
    
    // Update ticker
    updateTicker(`🏏 ${matchState.striker.name} is the new batsman • Ready to face the next ball`);
    
    // Check if we need to select a new bowler (for wicket on last ball of over)
    const currentBalls = matchState.currentBalls || 0;
    const isLastBallOfOver = (currentBalls % 6 === 0);
    
    if (isLastBallOfOver) {
        console.log('Batsman selected, now selecting new bowler for over completion');
        setTimeout(() => {
            completeOver();
        }, 500);
    }
}

function closeNewBatsmanModal() {
    const modal = document.getElementById('player-modal');
    modal.style.display = 'none';
    
    // Remove event listener
    const batsmanSelect = document.getElementById('new-batsman-select');
    if (batsmanSelect) {
        batsmanSelect.removeEventListener('change', updateNewBatsmanPreview);
    }
    
    // Reset modal to original opening players selection content
    resetModalToOriginal();
}

function resetModalToOriginal() {
    const modal = document.getElementById('player-modal');
    const modalContent = modal.querySelector('.modal-content');
    
    // Restore original modal content for opening players selection
    modalContent.innerHTML = `
        <h3 id="modal-title">Select Opening Players</h3>
        
        <!-- Batsmen Selection -->
        <div class="selection-section">
            <h4>🏏 Select Opening Batsmen</h4>
            <div class="player-grid">
                <div class="player-column">
                    <label>Striker (on strike):</label>
                    <select id="striker-select" class="player-select-dropdown">
                        <option value="">Choose striker...</option>
                    </select>
                </div>
                <div class="player-column">
                    <label>Non-striker:</label>
                    <select id="non-striker-select" class="player-select-dropdown">
                        <option value="">Choose non-striker...</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Bowler Selection -->
        <div class="selection-section">
            <h4>⚾ Select Opening Bowler</h4>
            <div class="player-grid">
                <div class="player-column">
                    <label>Opening Bowler:</label>
                    <select id="bowler-select" class="player-select-dropdown">
                        <option value="">Choose bowler...</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Player Stats Preview -->
        <div class="player-preview" id="player-preview">
            <!-- Player stats will be shown here -->
        </div>
        
        <!-- Action Buttons -->
        <div class="modal-actions">
            <button class="btn btn-primary" onclick="confirmPlayerSelection()">✅ Confirm Selection</button>
            <button class="btn btn-secondary" onclick="closePlayerModal()">❌ Cancel</button>
        </div>
    `;
    
    // Re-populate the dropdowns and re-attach event listeners
    if (matchState.battingTeam && matchState.bowlingTeam) {
        populatePlayerDropdowns();
        document.getElementById('striker-select').addEventListener('change', updatePlayerPreview);
        document.getElementById('non-striker-select').addEventListener('change', updatePlayerPreview);
        document.getElementById('bowler-select').addEventListener('change', updatePlayerPreview);
    }
}

function completeOver() {
    // Clear balls display
    document.getElementById('balls-container').innerHTML = '';
    
    // Swap strike at end of over
    swapStrike();
    
    // Update bowler overs
    if (matchState.currentBowler) {
        matchState.currentBowler.oversBowled = Math.floor(matchState.currentBowler.oversBowled || 0) + 1;
    }
    
    // Check if innings should end after this over
    const totalBalls = matchState.ballsFaced || 0;
    const maxBalls = MATCH_DATA.max_overs * 6;
    
    if (totalBalls >= maxBalls) {
        // Innings completed due to overs
        showNotification('Innings completed - all overs bowled!', 'info');
        setTimeout(() => {
            endInnings();
        }, 1000);
    } else {
        // More overs to go - select new bowler
        selectNewBowler();
        showNotification('Over completed!', 'info');
    }
    
    // Reset button to "Next Ball" after selection
    resetNextBallButton();
}

function resetNextBallButton() {
    const nextBallBtn = document.getElementById('next-ball-btn');
    nextBallBtn.textContent = '🎯 Next Ball';
    nextBallBtn.onclick = simulateDelivery;
    nextBallBtn.disabled = false;
}

function selectNewBowler() {
    // Get available bowlers (haven't bowled max overs, not current bowler)
    const maxOvers = MATCH_DATA.match_type === 'T20' ? 4 : 10;
    const availableBowlers = matchState.bowlingTeam.players.filter(player => 
        (player.oversBowled || 0) < maxOvers && 
        player.id !== matchState.currentBowler.id
    );
    
    if (availableBowlers.length > 0) {
        // Open modal for user to select new bowler
        openNewBowlerModal(availableBowlers);
    } else {
        // No more bowlers available
        showNotification('No more bowlers available - all have bowled their maximum overs', 'info');
    }
}

function openNewBowlerModal(availableBowlers) {
    const modal = document.getElementById('player-modal');
    
    // Update modal title and content for new bowler selection
    document.getElementById('modal-title').textContent = '⚾ Select New Bowler';
    
    // Clear previous content
    const modalContent = modal.querySelector('.modal-content');
    
    // Create new bowler selection interface
    modalContent.innerHTML = `
        <h3 id="modal-title">⚾ Select New Bowler</h3>
        
        <div class="selection-section">
            <h4>🔄 New Bowler Selection</h4>
            <p>Choose who will bowl the next over:</p>
            
            <div class="player-grid">
                <div class="player-column">
                    <label>New Bowler:</label>
                    <select id="new-bowler-select" class="player-select-dropdown">
                        <option value="">Choose new bowler...</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Player Stats Preview -->
        <div class="player-preview" id="player-preview">
            <!-- Player stats will be shown here -->
        </div>
        
        <!-- Action Buttons -->
        <div class="modal-actions">
            <button class="btn btn-primary" onclick="confirmNewBowler()">✅ Confirm Selection</button>
            <button class="btn btn-secondary" onclick="closeNewBowlerModal()">❌ Cancel</button>
        </div>
    `;
    
    // Populate dropdown with available bowlers
    populateNewBowlerDropdown(availableBowlers);
    
    // Show modal
    modal.style.display = 'block';
    
    // Add event listener for bowler selection changes
    document.getElementById('new-bowler-select').addEventListener('change', updateNewBowlerPreview);
}

function populateNewBowlerDropdown(availableBowlers) {
    const bowlerSelect = document.getElementById('new-bowler-select');
    
    // Clear existing options
    bowlerSelect.innerHTML = '<option value="">Choose new bowler...</option>';
    
    // Populate dropdown with available bowlers
    availableBowlers.forEach(player => {
        const option = document.createElement('option');
        option.value = player.id;
        const oversBowled = (player.oversBowled || 0).toFixed(1);
        const maxOvers = MATCH_DATA.match_type === 'T20' ? 4 : 10;
        const remainingOvers = (maxOvers - (player.oversBowled || 0)).toFixed(1);
        option.textContent = `${player.name} (${player.bowling_type}, Skill: ${player.bowling_skill}, Overs: ${oversBowled}/${maxOvers})`;
        bowlerSelect.appendChild(option);
    });
}

function updateNewBowlerPreview() {
    const bowlerId = document.getElementById('new-bowler-select').value;
    const previewDiv = document.getElementById('player-preview');
    
    if (bowlerId) {
        const bowler = matchState.bowlingTeam.players.find(p => p.id == bowlerId);
        const oversBowled = (bowler.oversBowled || 0).toFixed(1);
        const maxOvers = MATCH_DATA.match_type === 'T20' ? 4 : 10;
        const remainingOvers = (maxOvers - (bowler.oversBowled || 0)).toFixed(1);
        
        previewDiv.innerHTML = `
            <h4>📊 New Bowler Preview</h4>
            <div class="player-preview-item">
                <strong>⚾ New Bowler:</strong> ${bowler.name}<br>
                Type: ${bowler.bowling_type} | Skill: ${bowler.bowling_skill}<br>
                Overs Bowled: ${oversBowled}/${maxOvers} | Remaining: ${remainingOvers}
            </div>
        `;
    } else {
        previewDiv.innerHTML = '<h4>📊 New Bowler Preview</h4><p>Select a bowler to see their stats</p>';
    }
}

function confirmNewBowler() {
    const bowlerId = document.getElementById('new-bowler-select').value;
    
    if (!bowlerId) {
        showNotification('Please select a new bowler', 'error');
        return;
    }
    
    // Get the selected bowler
    const newBowler = matchState.bowlingTeam.players.find(p => p.id == bowlerId);
    
    // Set as new bowler
    matchState.currentBowler = newBowler;
    
    // Initialize bowler stats if not already set
    if (!matchState.currentBowler.oversBowled) {
        matchState.currentBowler.oversBowled = 0;
        matchState.currentBowler.runsConceded = 0;
        matchState.currentBowler.wicketsTaken = 0;
    }
    
    // Close modal
    closeNewBowlerModal();
    
    // Update display
    document.getElementById('bowler-name').textContent = matchState.currentBowler.name;
    
    // Show confirmation
    showNotification(`${matchState.currentBowler.name} to bowl`, 'success');
    
    // Update ticker
    updateTicker(`⚾ ${matchState.currentBowler.name} will bowl the next over • ${matchState.currentBowler.bowling_type} bowling`);
}

function closeNewBowlerModal() {
    const modal = document.getElementById('player-modal');
    modal.style.display = 'none';
    
    // Remove event listener
    const bowlerSelect = document.getElementById('new-bowler-select');
    if (bowlerSelect) {
        bowlerSelect.removeEventListener('change', updateNewBowlerPreview);
    }
    
    // Reset modal to original opening players selection content
    resetModalToOriginal();
}

function checkInningsCompletion() {
    const totalBalls = matchState.ballsFaced || 0;
    const maxBalls = MATCH_DATA.max_overs * 6;

    if (totalBalls >= maxBalls || matchState.wicketsLost >= 10) {
        // Overs completed or all wickets fallen
        endInnings();
        return; // Exit early to prevent further processing
    }
    
    if (matchState.currentInnings > 1) {
        // Second innings - end when target reached, overs complete, or all wickets fall
        if (matchState.totalRuns >= matchState.target) {
            // Target achieved - batting team wins
            endInnings();
            return; // Exit early to prevent further processing
        }
    }
}

function endMatch() {
    // Determine match result
    let result;
    if (matchState.currentInnings === 2) {
        if (matchState.totalRuns >= matchState.target) {
            result = `${matchState.battingTeam.short_name} won by ${10 - matchState.wicketsLost} wickets`;
        } else {
            result = `${matchState.bowlingTeam.short_name} won by ${matchState.firstInningsScore - matchState.totalRuns} runs`;
        }
    }
    
    // Store the result for display
    matchState.matchResult = result;
    
    showNotification(`Match completed! ${result}`, 'success');
    updateTicker(`🏏 Match Over • ${result}`);
    
    // Update projection info to show result
    document.getElementById('projection-info').textContent = `🏆 ${result}`;
    
    // Disable all simulation controls
    document.getElementById('next-ball-btn').disabled = true;
    document.getElementById('auto-sim-btn').disabled = true;
    
    // Update match status
    updateMatchStatus('completed');
}

function endInnings() {
    if (matchState.currentInnings === 1) {
        // First innings completed
        matchState.firstInningsScore = matchState.totalRuns;
        matchState.target = matchState.firstInningsScore + 1;
        
        showNotification('First innings completed!', 'success');
        updateTicker(`🏏 First innings ends • ${matchState.battingTeam.short_name}: ${matchState.totalRuns}/${matchState.wicketsLost} • Target: ${matchState.target}`);
        
        // Switch teams for second innings
        matchState.secondInningsBattingTeam = matchState.bowlingTeam;
        matchState.secondInningsBowlingTeam = matchState.battingTeam;
        
        // Start second innings
        setTimeout(() => {
            startSecondInnings();
        }, 2000);
    } else {
        // Second innings completed - match over
        showNotification('Match completed!', 'success');
        endMatch();
    }
}

function startSecondInnings() {
    // Update match state for second innings
    matchState.currentInnings = 2;
    matchState.battingTeam = matchState.secondInningsBattingTeam;
    matchState.bowlingTeam = matchState.secondInningsBowlingTeam;
    
    // Reset match stats for second innings
    matchState.totalRuns = 0;
    matchState.wicketsLost = 0;
    matchState.ballsFaced = 0;
    matchState.currentBalls = 0;
    matchState.battingOrderPlayers = [];
    matchState.wicketkeeper = matchState.bowlingTeam.players.find(p => p.is_wicketkeeper);
    
    // Update display for second innings
    updateMatchDisplay();
    
    // Show second innings controls
    document.getElementById('live-controls').style.display = 'block';
    document.getElementById('player-status').style.display = 'grid';
    document.getElementById('over-display').style.display = 'block';
    
    // Update status
    updateMatchStatus('live');
    
    // Prompt for opening batsmen and bowler selection for second innings
    selectOpeningPlayers();
    
    showNotification('Second innings starting!', 'info');
    updateTicker(`🏏 Second innings begins • ${matchState.battingTeam.short_name} need ${matchState.target} to win`);
}

function autoSimulate() {
    if (matchState.isAutoSimulating) return;
    
    matchState.isAutoSimulating = true;
    document.getElementById('auto-sim-btn').style.display = 'none';
    document.getElementById('pause-btn').style.display = 'inline-block';
    
    matchState.autoInterval = setInterval(() => {
        simulateDelivery();
    }, 1500); // Simulate a ball every 1.5 seconds
}

function pauseSimulation() {
    matchState.isAutoSimulating = false;
    document.getElementById('auto-sim-btn').style.display = 'inline-block';
    document.getElementById('pause-btn').style.display = 'none';
    
    if (matchState.autoInterval) {
        clearInterval(matchState.autoInterval);
        matchState.autoInterval = null;
    }
}

function updateMatchStatus(status) {
    const statusIndicator = document.getElementById('status-indicator');
    const statusText = document.getElementById('match-status');
    
    statusIndicator.className = `status-indicator status-${status}`;
    statusText.textContent = status.charAt(0).toUpperCase() + status.slice(1);
}

function updateTicker(message) {
    document.getElementById('ticker-content').textContent = message;
}

function updateMatchDisplay() {
    // Initialize default values if match just started
    if (!matchState.totalRuns) {
        matchState.totalRuns = 0;
        matchState.wicketsLost = 0;
        matchState.ballsFaced = 0;
    }
    
    if (matchState.currentInnings === 1) {
        // First innings
        document.getElementById('team1-name').textContent = matchState.battingTeam ? matchState.battingTeam.short_name : MATCH_DATA.team1.short_name;
        document.getElementById('team2-name').textContent = matchState.bowlingTeam ? matchState.bowlingTeam.short_name : MATCH_DATA.team2.short_name;
        
        // Update scores for first innings
        document.getElementById('team1-score').textContent = `${matchState.totalRuns}/${matchState.wicketsLost}`;
        document.getElementById('team2-score').textContent = '-';
        document.getElementById('team2-rr').textContent = 'Target: -';
        
        const runRate = (((matchState.totalRuns || 0) * 6) / (matchState.currentBalls || 1)).toFixed(2);
        document.getElementById('team1-rr').textContent = `RR: ${runRate}`;
        
        // Show projected score for first innings
        const projectedScore = Math.round(runRate * MATCH_DATA.max_overs);
        document.getElementById('projection-info').textContent = `Projected score: ${projectedScore}`;
    } else {
        // Second innings
        document.getElementById('team1-name').textContent = matchState.battingTeam.short_name;
        document.getElementById('team2-name').textContent = matchState.bowlingTeam.short_name;
        
        // Update scores for second innings
        document.getElementById('team1-score').textContent = `${matchState.totalRuns}/${matchState.wicketsLost}`;
        document.getElementById('team2-score').textContent = `${matchState.firstInningsScore}/10`;
        
        // Calculate run rate and required run rate
        const runRate = (((matchState.totalRuns || 0) * 6) / (matchState.currentBalls || 1)).toFixed(2);
        const remainingRuns = matchState.target - matchState.totalRuns;
        const remainingBalls = (MATCH_DATA.max_overs * 6) - matchState.currentBalls;
        const requiredRunRate = remainingBalls > 0 ? (remainingRuns * 6 / remainingBalls).toFixed(2) : '0.00';
        
        document.getElementById('team1-rr').textContent = `RR: ${runRate} | RRR: ${requiredRunRate}`;
        document.getElementById('team2-rr').textContent = `Target: ${matchState.target}`;
        
        // Show runs needed for second innings
        document.getElementById('projection-info').textContent = `Need ${remainingRuns} runs from ${remainingBalls} balls`;
    }
    
    // Check if match is completed and show result
    if (matchState.matchResult) {
        document.getElementById('projection-info').textContent = `🏆 ${matchState.matchResult}`;
    }
    
    // Initialize batting and bowling lists
    updateBattingCard();
    updateBowlingCard();
}

function updateBattingCard() {
    const battingList = document.getElementById('batting-list');
    if (!matchState.battingTeam) return;
    
    battingList.innerHTML = '';
    
    // matchState.battingTeam.players.forEach(player => {
    matchState.battingOrderPlayers.forEach(player => {
        const row = document.createElement('div');
        row.className = 'batting-row';
        
        if (player.id === matchState.striker?.id || player.id === matchState.nonStriker?.id) {
            row.classList.add('current', 'not-out');
        } else if (player.isOut) {
            row.classList.add('out');
        } else if (player.hasAlreadyBatted) {
            row.classList.add('not-out');
        }
        
        const runs = player.runs || 0;
        const balls = player.ballsFaced || 0;
        const sr = balls > 0 ? ((runs / balls) * 100).toFixed(1) : '0.0';
        
        row.innerHTML = `
            <div>${player.name}${player.is_captain ? ' (c)' : ''}${player.is_wicketkeeper ? ' (wk)' : ''}</div>
            <div>${(player.id === matchState.striker?.id || player.id === matchState.nonStriker?.id) ? runs  + '*': runs}</div>
            <div>${balls}</div>
            <div>${sr}</div>
        `;
        
        battingList.appendChild(row);
    });
}

function updateBowlingCard() {
    const bowlingList = document.getElementById('bowling-list');
    if (!matchState.bowlingTeam) return;
    
    bowlingList.innerHTML = '';
    
    matchState.bowlingTeam.players
        .filter(player => player.oversBowled > 0 || player.id === matchState.currentBowler?.id)
        .forEach(player => {
            const row = document.createElement('div');
            row.className = 'bowling-row';
            
            const overs = (player.oversBowled || 0).toFixed(1);
            const runs = player.runsConceded || 0;
            const wickets = player.wicketsTaken || 0;
            const ballsBowled = Math.floor(overs) * 6 + ((overs * 10) % 10)

            const economy = ballsBowled > 0 ? (runs * 6 / ballsBowled).toFixed(2) : '0.00';
            
            row.innerHTML = `
                <div>${player.name}</div>
                <div>${overs}</div>
                <div>${runs}</div>
                <div>${wickets}</div>
                <div>${economy}</div>
            `;
            
            bowlingList.appendChild(row);
        });
}

// Initialize match state based on current status
if (MATCH_DATA.status === 'first_innings' || MATCH_DATA.status === 'second_innings') {
    // Match is already in progress, load current state
    setTimeout(() => {
        document.getElementById('live-controls').style.display = 'block';
        document.getElementById('player-status').style.display = 'grid';
        document.getElementById('over-display').style.display = 'block';
        updateMatchStatus('live');
        selectOpeningPlayers();
    }, 1000);
}
</script>


<style>
    /* Use your beautiful concept 1 styles - Midnight Blue Elegance */
    .match-container {
        background: linear-gradient(135deg, #0c1445 0%, #1a237e 50%, #283593 100%);
        border-radius: 20px;
        overflow: hidden;
        border: 2px solid #1976d2;
        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        min-height: 600px;
        position: relative;
    }

    .top-banner {
        background: linear-gradient(90deg, rgba(0,0,0,0.9), rgba(25,118,210,0.3), rgba(0,0,0,0.9));
        border-bottom: 3px solid #2196f3;
        color: #e3f2fd;
        min-height: 80px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 30px;
        font-size: 1rem;
        font-weight: bold;
    }

    .team-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: 200px;
    }

    .team-info {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .team-name {
        font-size: 1.3rem;
        font-weight: bold;
    }

    .team-score {
        font-size: 1.8rem;
        font-weight: bold;
    }

    .run-rate {
        font-size: 0.9rem;
        opacity: 0.9;
    }

    .projection-info {
        font-size: 0.8rem;
        opacity: 0.8;
        color: #90caf9;
        margin-top: 2px;
        display: block;
        width: 100%;
        text-align: center;
    }

    .match-info {
        text-align: center;
        font-size: 0.9rem;
    }

    .main-content {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        padding: 20px;
        min-height: 480px;
    }

    .center-area {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .player-status {
        background: rgba(0,0,0,0.6);
        border: 1px solid rgba(33,150,243,0.3);
        box-shadow: 0 0 20px rgba(33,150,243,0.1);
        border-radius: 15px;
        padding: 20px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .batsman {
        text-align: center;
        position: relative;
        padding: 15px;
        border-radius: 10px;
        transition: all 0.3s ease;
    }

    .batsman.on-strike {
        background: rgba(255,215,0,0.2);
        border: 2px solid rgba(255,215,0,0.4);
    }

    .batsman.on-strike::before {
        content: "★";
        position: absolute;
        top: -5px;
        right: -5px;
        color: #ffd700;
        font-size: 1.2rem;
        animation: sparkle 2s ease-in-out infinite;
    }

    @keyframes sparkle {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.5; transform: scale(1.2); }
    }

    .player-name {
        font-size: 1.2rem;
        font-weight: bold;
        margin-bottom: 8px;
        color: #e3f2fd;
    }

    .player-stats {
        font-size: 0.9rem;
        opacity: 0.9;
        color: #bbdefb;
    }

    .over-display {
        background: rgba(0,0,0,0.6);
        border: 1px solid rgba(33,150,243,0.3);
        box-shadow: 0 0 20px rgba(33,150,243,0.1);
        border-radius: 15px;
        padding: 20px;
        flex: 1;
    }

    .current-over-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .bowler-name {
        font-size: 1.1rem;
        font-weight: bold;
        color: #e3f2fd;
    }

    .over-number {
        font-size: 1rem;
        opacity: 0.8;
        color: #90caf9;
    }

    .balls-container {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
        min-height: 40px;
    }

    .ball {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
        font-weight: bold;
        animation: ballAppear 0.5s ease-out;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    @keyframes ballAppear {
        0% { transform: scale(0) rotate(180deg); opacity: 0; }
        100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }

    .ball.dot { background: #6c757d; color: white; }
    .ball.runs { background: #007bff; color: white; }
    .ball.four { background: #28a745; color: white; }
    .ball.six { background: #dc3545; color: white; }
    .ball.wicket { background: #6f42c1; color: white; }
    .ball.wide { background: #ffc107; color: black; }
    .ball.noball { background: #fd7e14; color: white; }

    .scorecards {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .scorecard {
        background: rgba(0,0,0,0.6);
        border: 1px solid rgba(33,150,243,0.3);
        box-shadow: 0 0 20px rgba(33,150,243,0.1);
        border-radius: 15px;
        padding: 20px;
    }

    .scorecard-title {
        font-size: 1.1rem;
        font-weight: bold;
        margin-bottom: 15px;
        text-align: center;
        color: #2196f3;
    }

    .batting-list, .bowling-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 200px;
        overflow-y: auto;
    }

    .batting-row, .bowling-row {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr;
        padding: 8px;
        border-radius: 8px;
        font-size: 0.9rem;
        transition: background 0.3s ease;
        color: #e3f2fd;
    }

    .batting-row:hover, .bowling-row:hover {
        background: rgba(33,150,243,0.1);
    }

    .bowling-row {
        grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
    }

    .batting-row.current {
        background: rgba(255,215,0,0.1);
        border: 1px solid rgba(255,215,0,0.3);
    }

    .batting-row.not-out {
        color: #4caf50;
    }

    .batting-row.out {
        color: #f44336;
        opacity: 0.7;
    }

    .bottom-ticker {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 40px;
        background: linear-gradient(90deg, #1565c0, #1976d2);
        color: white;
        display: flex;
        align-items: center;
        padding: 0 20px;
        font-size: 0.9rem;
        overflow: hidden;
        white-space: nowrap;
    }

    .ticker-content {
        animation: tickerScroll 20s linear infinite;
    }

    @keyframes tickerScroll {
        0% { transform: translateX(100%); }
        100% { transform: translateX(-100%); }
    }

    .match-controls {
        background: rgba(33,150,243,0.1);
        border: 1px solid rgba(33,150,243,0.3);
        border-radius: 15px;
        padding: 20px;
        margin-top: 20px;
        text-align: center;
    }

    .control-section {
        margin-bottom: 20px;
    }

    .control-title {
        font-size: 1.1rem;
        font-weight: bold;
        margin-bottom: 10px;
        color: #2196f3;
    }

    .btn {
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        margin: 5px;
        transition: all 0.3s ease;
    }

    .btn-primary {
        background: linear-gradient(45deg, #1565c0, #2196f3);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(33,150,243,0.3);
    }

    .btn-success {
        background: linear-gradient(45deg, #2e7d32, #4caf50);
        color: white;
    }

    .btn-warning {
        background: linear-gradient(45deg, #f57c00, #ff9800);
        color: white;
    }

    .btn-danger {
        background: linear-gradient(45deg, #c62828, #f44336);
        color: white;
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .toss-section {
        background: rgba(255,215,0,0.1);
        border: 2px solid rgba(255,215,0,0.3);
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        margin-bottom: 20px;
    }

    .toss-options {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin: 20px 0;
    }

    .radio-group {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 15px;
        background: rgba(0,0,0,0.3);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .radio-group:hover {
        background: rgba(255,215,0,0.1);
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 1000;
    }

    .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #1a1a1a;
        border-radius: 15px;
        padding: 30px;
        max-width: 600px;
        width: 90%;
        text-align: center;
        box-sizing: border-box;
    }

    .player-select {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
        margin: 20px 0;
    }

    .player-option {
        padding: 10px;
        background: rgba(33,150,243,0.2);
        border: 1px solid rgba(33,150,243,0.3);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .player-option:hover {
        background: rgba(33,150,243,0.4);
        transform: translateY(-2px);
    }

    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }

    .status-setup { background: #ffc107; }
    .status-toss { background: #ff9800; }
    .status-live { background: #4caf50; animation: pulse 2s ease-in-out infinite; }
    .status-completed { background: #9e9e9e; }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* Player Selection Modal Styles */
    .selection-section {
        margin-bottom: 25px;
        padding: 15px;
        background: rgba(0,0,0,0.3);
        border-radius: 10px;
        border: 1px solid rgba(33,150,243,0.2);
    }

    .selection-section h4 {
        margin-bottom: 15px;
        color: #2196f3;
        font-size: 1.1rem;
    }

    .player-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        width: 100%;
        max-width: 100%;
    }

    .player-column {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .player-column label {
        font-weight: bold;
        color: #e3f2fd;
        font-size: 0.9rem;
    }

    .player-select-dropdown {
        padding: 10px;
        background: rgba(0,0,0,0.5);
        border: 1px solid rgba(33,150,243,0.3);
        border-radius: 6px;
        color: #fff;
        font-size: 0.9rem;
        cursor: pointer;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .player-select-dropdown:focus {
        outline: none;
        border-color: #2196f3;
        box-shadow: 0 0 10px rgba(33,150,243,0.3);
    }

    .player-select-dropdown option {
        background: #1a1a1a;
        color: #fff;
        padding: 8px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .player-preview {
        margin: 20px 0;
        padding: 15px;
        background: rgba(0,0,0,0.4);
        border-radius: 10px;
        border: 1px solid rgba(33,150,243,0.2);
    }

    .player-preview h4 {
        margin-bottom: 15px;
        color: #4caf50;
        text-align: center;
    }

    .player-preview-item {
        margin-bottom: 12px;
        padding: 10px;
        background: rgba(33,150,243,0.1);
        border-radius: 6px;
        border-left: 3px solid #2196f3;
    }

    .modal-actions {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 25px;
    }

    .btn-secondary {
        background: linear-gradient(45deg, #6c757d, #495057);
        color: white;
    }

    .btn-secondary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(108,117,125,0.3);
    }
</style>
{% endblock %}

{% block content %}
<div class="match-container" id="match-container">
    <!-- Top Banner with Match Info -->
    <div class="top-banner">
        <div class="team-info">
            <div class="team-name" id="team1-name">{{ match.team1.short_name }}</div>
            <div class="team-score" id="team1-score">0/0</div>
            <div class="run-rate" id="team1-rr">RR: 0.00</div>
        </div>
        <div class="match-info">
            <div id="match-type">{{ match.match_type }} Match</div>
            <div id="match-overs">0.0/{{ {'T20': 20, 'ODI': 50}[match.match_type] }} overs</div>
            <div>
                <span class="status-indicator status-{{ match.status }}" id="status-indicator"></span>
                <span id="match-status">{{ match.status.title() }}</span>
            </div>
            <div class="projection-info" id="projection-info"></div>
        </div>
        <div class="team-section">
            <div class="team-info">
                <div class="run-rate" id="team2-rr">Target: -</div>
                <div class="team-score" id="team2-score">-</div>
                <div class="team-name" id="team2-name">{{ match.team2.short_name }}</div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <div class="center-area">
            <!-- Current Batsmen -->
            <div class="player-status" id="player-status" style="display: none;">
                <div class="batsman" id="striker">
                    <div class="player-name" id="striker-name">-</div>
                    <div class="player-stats" id="striker-stats">0* (0) | SR: 0.00<br>4s: 0 • 6s: 0</div>
                </div>
                <div class="batsman" id="non-striker">
                    <div class="player-name" id="non-striker-name">-</div>
                    <div class="player-stats" id="non-striker-stats">0* (0) | SR: 0.00<br>4s: 0 • 6s: 0</div>
                </div>
            </div>

            <!-- Current Over Display -->
            <div class="over-display" id="over-display" style="display: none;">
                <div class="current-over-info">
                    <div class="bowler-name" id="bowler-name">-</div>
                    <div class="over-number" id="over-number">Over 0.0</div>
                </div>
                <div class="balls-container" id="balls-container">
                    <!-- Balls will be added dynamically -->
                </div>
            </div>
        </div>

        <!-- Scorecards -->
        <div class="scorecards">
            <div class="scorecard">
                <div class="scorecard-title">🏏 Batting Card</div>
                <div class="batting-list" id="batting-list">
                    <!-- Batting stats will be populated here -->
                </div>
            </div>

            <div class="scorecard">
                <div class="scorecard-title">⚾ Bowling Figures</div>
                <div class="bowling-list" id="bowling-list">
                    <!-- Bowling stats will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Ticker -->
    <div class="bottom-ticker">
        <div class="ticker-content" id="ticker-content">
            🏏 Welcome to the Cricket Simulator • Match between {{ match.team1.full_name }} and {{ match.team2.full_name }}
        </div>
    </div>
</div>

<!-- Match Controls -->
<div class="match-controls" id="match-controls">
    <!-- Toss Section -->
    <div class="toss-section" id="toss-section" style="display: none;">
        <div class="control-title">🪙 Toss Time!</div>
        <p>{{ match.team1.full_name }} to call heads or tails</p>
        <div class="toss-options">
            <label class="radio-group">
                <input type="radio" name="toss-call" value="heads" checked>
                <span>Heads</span>
            </label>
            <label class="radio-group">
                <input type="radio" name="toss-call" value="tails">
                <span>Tails</span>
            </label>
        </div>
        <button class="btn btn-warning" onclick="conductToss()">🎲 Flip Coin</button>
    </div>

    <!-- Toss Decision Section -->
    <div class="control-section" id="toss-decision-section" style="display: none;">
        <div class="control-title">🏏 Toss Winner Decision</div>
        <div id="toss-result-text"></div>
        <div style="margin: 20px 0;">
            <button class="btn btn-primary" onclick="makeTossDecision('bat')">🏏 Bat First</button>
            <button class="btn btn-success" onclick="makeTossDecision('bowl')">⚾ Bowl First</button>
        </div>
    </div>

    <!-- Match Start Section -->
    <div class="control-section" id="start-section" style="display: none;">
        <div class="control-title">🚀 Ready to Start</div>
        <div id="batting-order-text"></div>
        <button class="btn btn-success" onclick="startMatch()">▶️ Start Match</button>
    </div>

    <!-- Live Match Controls -->
    <div class="control-section" id="live-controls" style="display: none;">
        <div class="control-title">⚡ Live Match</div>
        <button class="btn btn-primary" onclick="simulateDelivery()" id="next-ball-btn">🎯 Next Ball</button>
        <button class="btn btn-warning" onclick="autoSimulate()" id="auto-sim-btn">⚡ Auto Simulate</button>
        <button class="btn btn-danger" onclick="pauseSimulation()" id="pause-btn" style="display: none;">⏸️ Pause</button>
        
        <!-- Sound Controls -->
        <div class="sound-controls">
            <button class="btn btn-secondary" onclick="toggleSound()" id="sound-btn">🔊 Sound On</button>
            <div class="volume-control">
                <label for="volume-slider">🔊</label>
                <input type="range" id="volume-slider" min="0" max="100" value="70" onchange="setVolume(this.value/100)">
            </div>
        </div>
    </div>
</div>

<!-- Player Selection Modal -->
<div class="modal" id="player-modal">
    <div class="modal-content">
        <h3 id="modal-title">Select Opening Players</h3>
        
        <!-- Batsmen Selection -->
        <div class="selection-section">
            <h4>🏏 Select Opening Batsmen</h4>
            <div class="player-grid">
                <div class="player-column">
                    <label>Striker (on strike):</label>
                    <select id="striker-select" class="player-select-dropdown">
                        <option value="">Choose striker...</option>
                    </select>
                </div>
                <div class="player-column">
                    <label>Non-striker:</label>
                    <select id="non-striker-select" class="player-select-dropdown">
                        <option value="">Choose non-striker...</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Bowler Selection -->
        <div class="selection-section">
            <h4>⚾ Select Opening Bowler</h4>
            <div class="player-grid">
                <div class="player-column">
                    <label>Opening Bowler:</label>
                    <select id="bowler-select" class="player-select-dropdown">
                        <option value="">Choose bowler...</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Player Stats Preview -->
        <div class="player-preview" id="player-preview">
            <!-- Player stats will be shown here -->
        </div>
        
        <!-- Action Buttons -->
        <div class="modal-actions">
            <button class="btn btn-primary" onclick="confirmPlayerSelection()">✅ Confirm Selection</button>
            <button class="btn btn-secondary" onclick="closePlayerModal()">❌ Cancel</button>
        </div>
    </div>
</div>

<!-- Match Data (Hidden, for JavaScript) -->
<script>
    const MATCH_DATA = {
        match_id: "{{ match.match_id }}",
        team1: JSON.parse('{{ match.team1.to_dict() | tojson | safe }}'),
        team2: JSON.parse('{{ match.team2.to_dict() | tojson | safe }}'),
        match_type: "{{ match.match_type }}",
        status: "{{ match.status }}",
        max_overs: {{ {'T20': 20, 'ODI': 50}[match.match_type] }}
    };
    
    // Sound System
    const soundSystem = {
        sounds: {},
        isMuted: false,
        volume: 0.7,
        
        init() {
            // Create audio elements for each sound
            this.sounds = {
                six: this.createAudio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT'),
                four: this.createAudio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT'),
                wicket: this.createAudio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT')
            };
            
            // Set volume for all sounds
            Object.values(this.sounds).forEach(audio => {
                audio.volume = this.volume;
            });
            
            console.log('Sound system initialized');
        },
        
        createAudio(base64Data) {
            const audio = new Audio();
            audio.preload = 'auto';
            // For now using placeholder base64 data - you can replace with actual sound files
            return audio;
        },
        
        play(eventType) {
            if (this.isMuted || !this.sounds[eventType]) return;
            
            try {
                const sound = this.sounds[eventType];
                sound.currentTime = 0; // Reset to start
                sound.play().catch(e => {
                    console.log('Audio play failed:', e);
                });
            } catch (e) {
                console.log('Sound play error:', e);
            }
        },
        
        toggleMute() {
            this.isMuted = !this.isMuted;
            console.log('Sound muted:', this.isMuted);
            return this.isMuted;
        },
        
        setVolume(level) {
            this.volume = Math.max(0, Math.min(1, level));
            Object.values(this.sounds).forEach(audio => {
                audio.volume = this.volume;
            });
            console.log('Volume set to:', this.volume);
        }
    };
    
    // Event Animation System
    function showEventAnimation(title, eventType, subtitle) {
        // Play sound effect
        soundSystem.play(eventType);
        
        // Create animation container
        const animationContainer = document.createElement('div');
        animationContainer.className = `event-animation ${eventType}-animation`;
        
        // Create animation content
        animationContainer.innerHTML = `
            <div class="animation-content">
                <div class="animation-title">${title}</div>
                <div class="animation-subtitle">${subtitle}</div>
            </div>
        `;
        
        // Add to match container
        const matchContainer = document.getElementById('match-container');
        matchContainer.appendChild(animationContainer);
        
        // Trigger animation
        setTimeout(() => {
            animationContainer.classList.add('animate');
        }, 100);
        
        // Remove animation after completion
        setTimeout(() => {
            animationContainer.classList.add('fade-out');
            setTimeout(() => {
                if (animationContainer.parentNode) {
                    animationContainer.parentNode.removeChild(animationContainer);
                }
            }, 500);
        }, 2000);
    }
    
    // Sound Control Functions
    function toggleSound() {
        const isMuted = soundSystem.toggleMute();
        const soundBtn = document.getElementById('sound-btn');
        
        if (isMuted) {
            soundBtn.textContent = '🔇 Sound Off';
            soundBtn.classList.remove('btn-secondary');
            soundBtn.classList.add('btn-danger');
        } else {
            soundBtn.textContent = '🔊 Sound On';
            soundBtn.classList.remove('btn-danger');
            soundBtn.classList.add('btn-secondary');
        }
    }
    
    function setVolume(level) {
        soundSystem.setVolume(level);
    }
</script>
{% endblock %}